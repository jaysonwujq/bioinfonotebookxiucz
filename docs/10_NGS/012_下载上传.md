<!-- TOC -->

- [SRA数据下载：](#sra数据下载)
    - [搜索数据：](#搜索数据)
    - [下载方法](#下载方法)
        - [ascp](#ascp)
        - [prefetch下载SRA文件然后用fastq-dump转为fastq文件](#prefetch下载sra文件然后用fastq-dump转为fastq文件)
        - [SRATookit下载](#sratookit下载)
        - [ENA](#ena)
        - [SRA Explorer(https://sra-explorer.info/#)](#sra-explorerhttpssra-explorerinfo)
        - [迅雷下载](#迅雷下载)
    - [从AWS下载SRA原始数据(推荐)](#从aws下载sra原始数据推荐)
    - [SRA数据库](#sra数据库)
    - [查找数据](#查找数据)
    - [下载方法选择](#下载方法选择)
            - [Ref_Info](#ref_info)
    - [ascp: download SRA](#ascp-download-sra)
        - [ncbi](#ncbi)
            - [ascp error](#ascp-error)
        - [EBI](#ebi)
    - [wget/axel 批量下载](#wgetaxel-批量下载)
    - [prefetch: download SRA](#prefetch-download-sra)
    - [SRA Run Selector](#sra-run-selector)
    - [](#)
    - [fastq—dump：sra2fastq_pe](#fastqdumpsra2fastq_pe)
            - [Ref_Info](#ref_info-1)
    - [最新办法](#最新办法)
        - [wget](#wget)
    - [bypy将百度云盘数据下载到服务器](#bypy将百度云盘数据下载到服务器)
    - [https://github.com/saketkc/pysradb](#httpsgithubcomsaketkcpysradb)
- [上传](#上传)
    - [向NCBI SRA 提交原始数据](#向ncbi-sra-提交原始数据)
        - [Pacbio/Nanopore](#pacbionanopore)

<!-- /TOC -->

# SRA数据下载：

## 搜索数据：
```
PRJNA438770
==>
https://www.ncbi.nlm.nih.gov/Traces/study/
==>
https://www.ncbi.nlm.nih.gov/Traces/study/?acc=PRJNA438770&o=acc_s%3Aa
https://www.ncbi.nlm.nih.gov/Traces/study1/?acc=PRJNA438770(旧版)
==>
获取得到SRR_Acc_List.txt

#这种方法容易漏数据
PRJNA438770
==>
https://www.ncbi.nlm.nih.gov/sra/?term=PRJNA438770
==>
选中符合要求的数据，然后点击send to，RunInfo
==>
获取得到SraRunInfo.csv
```

## 下载方法
### ascp

根据电脑版本下载对应aspera connect server，下载地址：http://downloads.asperasoft.com/en/downloads/4

```
#NCBI
ftp://ftp.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByRun/sra/SRR/SRR690/SRR6904179/SRR6904179.sra


#ENA
http://ftp.sra.ebi.ac.uk/vol1/fastq/SRR121/SRR121621/SRR121621_1.fastq.gz

ascp -QT -l 300m -P 33001 -i ~/.aspera/connect/etc/asperaweb_id_dsa.openssh era-fasp@fasp.sra.ebi.ac.uk:/vol1/fastq/SRR121/SRR121621/SRR121621_1.fastq.gz path/to/download_dir

```

批量处理(旧版)
```
ftp='era-fasp@fasp.sra.ebi.ac.uk:/vol1/fastq'

mkdir sra  # make a output directory
cat SRR_Acc_List.txt |  while read i
 do
       SRR=$(echo ${i:0:6}) 
       # ascp -QT -l 300m -P 33001 -i ~/.aspera/connect/etc/asperaweb_id_dsa.openssh ${ftp}/${SRR}/${i}/{i}.fastq.gz ./sra 单端测序的话只有这一个文件
       ascp -QT -l 300m -P 33001 -i ~/.aspera/connect/etc/asperaweb_id_dsa.openssh ${ftp}/${SRR}/${i}/${i}_1.fastq.gz ./sra
       ascp -QT -l 300m -P 33001 -i ~/.aspera/connect/etc/asperaweb_id_dsa.openssh ${ftp}/${SRR}/${i}/${i}_2.fastq.gz ./sra
 done
```
批量处理
```
ftp='era-fasp@fasp.sra.ebi.ac.uk:/vol1/fastq'

cat>SRR_Acc_List.txt.download.parallel<<stop
stop

cat SRR_Acc_List.txt |  while read i
do
SRR=$(echo ${i:0:6}) ;  tmp_flag=$(echo 00${i:0-1:1});
cat>>SRR_Acc_List.txt.download.parallel<<stop
  ~/.aspera/connect/bin/ascp -QT -l 300m -P 33001 \
  -i ~/.aspera/connect/etc/asperaweb_id_dsa.openssh \
  ${ftp}/${SRR}/${tmp_flag}/${i}/${i}_1.fastq.gz ./sra_fq \
  && \
  ~/.aspera/connect/bin/ascp -QT -l 300m -P 33001 \
  -i ~/.aspera/connect/etc/asperaweb_id_dsa.openssh \
  ${ftp}/${SRR}/${tmp_flag}/${i}/${i}_2.fastq.gz ./sra_fq \
  && touch ./sra_fq/$i.success || touch ./sra_fq/$i.error
stop
done
```
### prefetch下载SRA文件然后用fastq-dump转为fastq文件
```
prefetch SRR11448442 -O `pwd` && echo "** SRR11448442.sra done **"
time fastq-dump --gzip --split-files -A SRR11448442 SRR11448442.sra && echo "** SRR11448442.sra to fastq done **"

cat SRR_Acc_List.txt | while read id; do (prefetch  ${id} );done
```

### SRATookit下载
  + NCBI 提供的下载软件
  + https://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=software
### ENA
https://www.ebi.ac.uk/ena/browser/home

### SRA Explorer(https://sra-explorer.info/#)
### 迅雷下载

生成`ftp://ftp-trace.ncbi.nih.gov/sra/sra-instant/reads/ByRun/sra/SRR/SRR563/SRR5631562/SRR5631562.sra` 格式，粘贴到迅雷中

注：头部都一样(黑色字)，后面地址分别为SRR，SRR+前三个数、SRR号、SSR号.sra
```
cat sra.txt|while read a ;do t1=${a:0:3};t2=${a:0:6};echo "ftp://ftp-trace.ncbi.nih.gov/sra/sra-instant/reads/ByRun/sra/$t1/$t2/$a/$a.sra";done
```
## 从AWS下载SRA原始数据(推荐)
https://cloud.tencent.com/developer/article/1867937

## SRA数据库
Sequence Read Archive：隶属NCBI (National Center for Biotechnology Information)，它是一个保存高通量测序原始数据以及比对信息和元数据 (metadata) 的数据库，所有已发表的文献中高通量测序数据基本都上传至此，方便其他研究者下载及再研究。其中的数据则是通过压缩后以.sra文件格式来保存的。

SRA（Sequence ReadArchive）数据库是用于存储二代测序的原始数据，包括 454，Illumina，SOLiD，IonTorrent，Helicos 和 CompleteGenomics。除了原始序列数据外，SRA现在也存在raw reads在参考基因的比对信息。

根据SRA数据产生的特点，将SRA数据分为四类：

Studies-- 研究课题

Experiments-- 实验设计

Runs-- 测序结果集

Samples-- 样品信息

SRA中数据结构的层次关系为：Studies->Experiments->Samples->Runs.

Studies是就实验目标而言的，一个study 可能包含多个Experiment。

Experiments包含了Sample、DNA source、测序平台、数据处理等信息；

一个Experiment可能包含一个或多个runs；

Runs 表示测序仪运行所产生的reads；

**SRA数据库用不同的前缀加以区分：**ERP或SRP表示Studies；SRS 表示 Samples；SRX 表示 Experiments；SRR 表示 Runs；

Studies:
+ SRA Study accessions (prefixes SRP, DRP, ERP)
+ Examples: SRP000002, DRP000617, ERP002000
+ BioProject accessions (prefixes PRJNA, PRJDB, PRJEB)
+ Examples: PRJNA111397, PRJDB90, PRJEB1976
+ dbGaP study accessions (prefix phs)
+ Example: phs000159
+ GEO Study (prefix GSE)
+ Example: GSE12578

Samples:
+ SRA Sample accessions (prefixes SRS, DRS, ERS)
+ Examples: SRS000013, DRS000020, ERS000016
+ BioSample accessions (prefixes SAMN, SAME)
+ Examples: SAMN00000013, SAMEA774460
+ GEO Sample (prefix GSM)
+ Example: GSM769008

SRA Experiment(s)
+ SRA Experiment accessions (prefixes SRX, DRX, ERX)
+ Example: SRX000002,SRX000003,SRX000004


## 查找数据
如果文献里面的SRA号，那么可以直接打开NCBI里面的搜索界面下载
如果文献里面是SRP号，那么该SRP会涉及到好几个SRA数据，得一个个开网站下载

**sratoolkit使用前，一定要修改config文件：**

https://github.com/ncbi/sra-tools/wiki/Toolkit-Configuration
## 下载方法选择
1）首选Aspera Connect软件

2）其次sratoolkit中的prefetch命令

3）最后，使用sratoolkit中的fastq-dump和sam-dump命令下载，如果fastq-dump不稳定，推荐大家尝试Biostar Handbook中的wonderdump脚本。

警告：不要用wget或curl去下载sra文件，这会导致下载的文件不完整！

#### Ref_Info
https://mp.weixin.qq.com/s/4Dd3L66ddYAS6C96VvN5kg

![sra1](https://note.youdao.com/yws/res/3447///note.youdao.com/src/C79FA46DCE8F4E07892CFB71E250CFE8)
![sra2](https://note.youdao.com/yws/res/3450///note.youdao.com/src/1C7871265C0D488DB8D2B7FA59DA8113)
![sra3](https://note.youdao.com/yws/res/3455///note.youdao.com/src/6245AAFEC67A47DE8B8551021B827FF7)


## ascp: download SRA
### ncbi
ncbiftp路径：
```
ftp://ftp.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByRun/sra/SRR/+SRR+登陆号前三位数字（548）+/SRR+完整登陆号（5483089）
```
安装ascp：
```
[zhangbo@mu01 bin]$ wget http://download.asperasoft.com/download/sw/connect/3.7.4/aspera-connect-3.7.4.147727-linux-64.tar.gz

#curl -O http://download.asperasoft.com/download/sw/connect/3.6.1/aspera-connect-3.6.1.110647-linux-64.tar.gz  

[zhangbo@mu01 bin]$ /home/zhangbo/.aspera/connect/bin/ascp -h

```
文件单个下载：
```
$ascp \
-i /home/zhangbo/.aspera/connect/etc/asperaweb_id_dsa.openssh \
-k1 -Tr -l100m \
anonftp@ftp-private.ncbi.nlm.nih.gov:/sra/sra-instant/reads/ByRun/sra/SRR/SRR606/SRR6061295/SRR6061295.sra \
~
```

文件批量下载：
```
$ascp \
-i /home/zhangbo/.aspera/connect/etc/asperaweb_id_dsa.openssh \
--mode recv --host ftp-private.ncbi.nlm.nih.gov --user anonftp \
--file-list  SRR_Download_List.txt \
~
```
SRR_Download_List.txt格式:
```
/sra/sra-instant/reads/ByRun/sra/SRR/SRR606/SRR6061295/SRR6061295.sra
/sra/sra-instant/reads/ByRun/sra/SRR/SRR606/SRR6061296/SRR6061296.sra
```

#### ascp error 
```
SRR6061311.sra                                                                                              100% 4653MB           - stalled -
```
### EBI
## wget/axel 批量下载
20180919:最后发现，我的网速还可以，直接axel了，ascp总是卡在100%处。
```
SRR6061309
SRR6061310
SRR6061311
SRR6061312
```
```
[zhangbo@mu01 cnvdata]$ for i in `cat SRR_Acc_List.txt`;do axel -n 16 ftp://ftp.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByRun/sra/SRR/SRR606/${i}/${i}.sra;done
```


## prefetch: download SRA

```
prefetch=/local_data1/software/sratoolkit/sratoolkit.2.9.1-1-centos_linux64/bin/prefetch
#方法一
$prefetch --output-directory --option-file SRR_Acc_List.txt
#方法二
$prefetch SRR6061292
```
20180920:发现axel的结果不能被转化,于是：
```
$prefetch -t ascp --output-directory /local_data1/work/zhangbo/data/cnvdata/ --max-size 100G --ascp-path \ "/home/zhangbo/.aspera/connect/bin/ascp|/home/zhangbo/.aspera/connect/etc/asperaweb_id_dsa.openssh" --ascp-options "-k 1 -Tr -l 100M" \
SRR6061292
```


## SRA Run Selector
网址：https://www.ncbi.nlm.nih.gov/Traces/study/

## 
https://www.ebi.ac.uk/ena

## fastq—dump：sra2fastq_pe

区分正反向reads一定要加上如下参数
```
/lustre/Work/software/common/sraToolkit/sratoolkit.2.9.0-centos_linux64/bin/fastq-dump \
--gzip \
--defline-qual '+' \
--defline-seq '@$ac-$si/$ri length=$rl' \
--split-3 ERR1831346.sra

/lustre/Work/software/common/sraToolkit/sratoolkit.2.9.0-centos_linux64/bin/fastq-dump \
--gzip \
--split-3 ERR1831346.sra \
-I
```
--origfmt: 是否要加上；

#### Ref_Info
http://bioinfostar.com/2017/12/23/How-to-download-SRA-data-zh_CN/

https://anjingwd.github.io/AnJingwd.github.io/2017/08/06/SRA格式数据加速下载打包解决/

https://mp.weixin.qq.com/s/e3xyZKpfkh8rL3sCxVEFlA

https://mp.weixin.qq.com/s/04AAaT8Ygp2UcZEbQsrw0A


## 最新办法
https://sra-explorer.info/#

https://www.jianshu.com/p/eb2c5331ce13?utm_source=desktop&utm_medium=timeline

https://github.com/pachterlab/ffq

https://github.com/saketkc/pysradb


### wget 
```
ftp='http://ftp.sra.ebi.ac.uk/vol1/fastq'

mkdir sra  # make a output directory
cat SRR_Acc_List.txt |  while read i
 do
       SRR=$(echo ${i:0:6}) 
       # wget -c -t 0 -P ./sra ${ftp}/${SRR}/${i}/${i}.fastq.gz 单端只有一个文件
       wget -c -t 0 -P ./sra ${ftp}/${SRR}/${i}/${i}_1.fastq.gz
       wget -c -t 0 -P ./sra ${ftp}/${SRR}/${i}/${i}_2.fastq.gz
 done
```

----


-----

rsync断点续传
网络传输速度很大程度上会影响我的工作。服务器与服务器之间的通连，有时scp不是最好的选择，例如：网络出现问题，两个服务器之间的连接断开后，使用scp再次连接时无法进行断点续传。

使用rsync做服务器之间的文件传输（备份），可以做到断点续传。

rsync -avzP -e 'ssh -p 8888' abc@xxx.xxx.xxx.xxxx:/home/abc/filename ./
wget并行下载
-P 8八线程，-t 0无限重试，-nv 下载时只显示更新和出错信息，不显示指令的详细执行过程

就是输入的地址urls.txt，每一行用一个wget命令进行下载，一次最多同时下载8个文件。

xargs -P 8 -n 1 wget -nv -c -t 0 <urls.txt
wget下载动态连接的文件
wget -c 'http://some.site.com/download?id=234&status=download' -O output_filename
随时上网检索一下，上面这个方法不一定每个动态连接的文件都能下载，例如google网盘的。

aria2分段下载大文件
-s 3 分成3份，-x 3 用3个连接从服务器下载文件
```
aria2c  -s 3 -x 3 "https://baidu.com/d/datadump.current.zip"
```

----
## bypy将百度云盘数据下载到服务器


安装信息：(bypy)[https://github.com/houtianze/bypy]

测试发现，大文件上传比慢。文件只能上传到全部文件>apps>bypy这个文件夹。

下载一系列FTP上的文件
这是压箱底的老程序，filetype这里其实不需要使用一个循环，如果只有一个类型的话，直接在下载的循环中用grep筛出这个变量。

```
bypy list 显示百度网盘 /apps（我的应用数据）/bypy 目录下的所有文件。
bypy upload [localpath] [remotepath] [ondup] 或 bypy syncup [localdir] [remotedir] [deleteremote] 上传文件到百度网盘
bypy downfile <remotefile> [localpath] 从百度网盘下载单个文件
bypy downdir [remotedir] [localdir] 从百度网盘下载整个文件夹
```

---
```
#!/bin/bash

for filetype in pdf; 
do 
  for net in `grep "$filetype" file.list2 | sed "s/\<td\>\<a href=\"//g" | sed "s/\"//g" | sed "s/<TD//g"`; 
  do 
    if [ ! -f $net ]
    then
    echo $net
    #wget  $path/$net
    fi
  done
done
```

## https://github.com/saketkc/pysradb




https://www.jianshu.com/p/d587728acc52

https://github.com/wwood/kingfisher-download

# 上传
## 向NCBI SRA 提交原始数据
https://zhuanlan.zhihu.com/p/149557150

### Pacbio/Nanopore 
![](./202220311.jpg)


