## Construct an unmmaped BAM tagged with UMIs
```
java \

```
## Align reads
When you have an unmapped BAM file with RX tags, use a combination of an aligner and Picard’s MergeBamAlignment tool to generate a mapped BAM that includes all necessary metadata. An example invocation follows:
```

```
## Map BAM to consensus reads
1.	**Identify which reads come from the same source molecule** by using fgbio’s GroupReadsByUmi tool, which assigns a unique source molecule ID to each applicable read, stores the ID in the MI tag, and outputs a BAM fi	that is sorted by the MI tag and ready for consensus calling. The source molecule is identifi using a combination of UMI sequence and mapping positions from reads 1
and 2. An example invocation follows:
```
```
 GroupReadsByUmi implements several strategies for matching UMIs to account for sequencing error. The adjacency method implements the directed adjacency graph method introduced by UMI-tools [1]. Parameters are available to control how many errors are allowed when matching UMIs at the same position and for filtering (i.e., ignoring) reads with low mapping quality. Low mapping quality reads should be ignored to prevent multiple consensus reads from being generated from multiple mismapped copies of the same source molecule.

2.	**Combine each set of reads to generate consensus reads** using fgbio’s CallMolecularConsensusReads. This step generates unmapped consensus reads from the output of GroupReadsByUmi. There are many parameters that affect the consensus calling; for an up-to-date listing and supporting documentation, run CallMolecularConsensusReads with the -h option. An example invocation follows with recommended parameters:
```
```
This script produces consensus reads for all molecules that have at least one observation.

3.	**Filter consensus reads** generated by CallMolecularConsensusReads using fgbio’s FilterConsensusReads. There are two kinds of fi	1) masking or filter individual bases in reads, and 2) filtering reads (i.e., not writing them to the output file). Base-level masking/filtering is only applied if per-base tags are present (see the documentation for CallMolecularConsensusReads for tag descriptions). Read-level filtering is always applied.

When filtering reads, secondary alignments and supplementary records may be removed independently if they fail one or more filters. If either R1 or R2 primary alignments fail a filter, then all records for the template will be filtered out. There are many parameters that affect the filtering of the consensus reads. For an up-to-date listing and supporting documentation, run FilterConsensusRead with the -h option. FilterConsensusRead can be
applied to either mapped or unmapped BAM files. An example invocation with recommended parameters follows:

 

This script produces a filtered, consensus BAM file containing sequences from molecules that were observed at least three times: min-reads=3.

https://www.n-genetics.com/products/1104/1023/19314.pdf

---
marp: true
size: 4:3
theme: default
---

https://sfvideo.blob.core.windows.net/sitefinity/docs/default-source/user-guide-manual/analysis-guideline-variant-calling-data-with-umis.pdf?sfvrsn=d0aa3207_26

https://sfvideo.blob.core.windows.net/sitefinity/docs/default-source/user-guide-manual/xgen-prism-dna-library-prep-kit-processing-sequencing-data-with-umis.pdf?sfvrsn=22991407_10

---

## Construct an unmmaped BAM tagged with UMIs
The optimal way to generate a mapped BAM with UMIs depends on the raw data format (e.g., FASTQ, BCL) and existing processing pipelines. Ultimately, you want a BAM file where the UMI sequence is stored in the RX tag for each read. Read 1 and read 2 of the same pair should have the same value stored in the RX tag, regardless which read contains the UMI sequence.

---

#### Multiple tools exist to help with this process:

1.	Picard’s **IlluminaBasecallsToSam** processes Illumina instrument run folders containing BCL fi	and produces demultiplexed, per-sample, unmapped BAM fi	The tool extracts UMI sequences from anywhere in the template or index reads into the RX tag.
2.	fgbio’s **AnnotateBamWithUmis** adds the UMIs from a FASTQ fi	to the RX tag of reads in a pre-existing BAM fi	by matching read names between the fi
3.	fgbio’s **ExtractUmisFromBam** processes unmapped BAM fi	where the UMIs are contained within read 1 or read 2 sequences, and extracts the UMI sequences into the RX tag.

---